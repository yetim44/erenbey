<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Erenin İtleri – Tahmin & Arşiv (CFC Tekrarsız)</title>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root{
    --bg:#0b1220; --ink:#e5e7eb; --muted:#94a3b8;
    --card:#0f172a; --panel:#10233b; --border:#1f2a44; --shadow:0 12px 40px rgba(0,0,0,.35);
    --r1:#d32f2f; --r2:#1976d2; --r3:#f8fafc; --r4:#111827; --r5:#f59e0b; --r6:#16a34a;
  }
  *{box-sizing:border-box} body{margin:0;background:
    radial-gradient(80rem 60rem at -20% -20%, #122a57 0%, transparent 60%),
    radial-gradient(60rem 50rem at 120% 0%, #1b443a 0%, transparent 60%),
    linear-gradient(180deg, #0b1220, #0b1220);
    color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;
    background:linear-gradient(135deg,#0c2a4a,#0f1e36); border:1px solid var(--border);
    border-radius:18px; padding:16px 18px; box-shadow:var(--shadow);}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:50%; background:conic-gradient(#10b981,#16a34a,#22c55e,#10b981);
    display:grid;place-items:center;box-shadow:0 10px 30px rgba(16,185,129,.25)}
  .logo svg{width:36px;height:36px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.35))}
  h1{margin:0;font-size:26px;font-weight:900;letter-spacing:.4px}
  .sub{color:var(--muted);font-size:13px}
  .clock{font-weight:900;font-size:40px;text-align:right;letter-spacing:1px}
  .board{margin-top:16px;display:grid;grid-template-columns:2.1fr 1fr;gap:16px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:16px}
  .mini{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px}
  .pill{background:#0b6;color:#021;padding:6px 10px;border-radius:12px;font-weight:800;font-size:12px}
  .grid{display:grid;gap:14px}
  .racegrid{grid-template-columns:1fr 1fr}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .dogcard{display:grid;grid-template-columns:auto 1fr;align-items:center;gap:12px;background:#0b1a2e;border:1px solid var(--border);border-radius:14px;padding:10px 12px}
  .badge{width:44px;height:44px;border-radius:10px;display:grid;place-items:center;font-weight:900;font-size:20px;color:#fff;box-shadow:inset 0 -3px 0 rgba(0,0,0,.25);border:2px solid rgba(255,255,255,.15)}
  .b1{background:var(--r1)} .b2{background:var(--r2)} .b3{background:var(--r3);color:#0b1220} .b4{background:var(--r4)} .b5{background:var(--r5);color:#111} .b6{background:var(--r6);color:#021}
  .oddbox{display:flex;align-items:center;gap:8px;background:#fff;color:#0b1220;padding:8px 10px;border-radius:12px;box-shadow:inset 0 -2px 0 rgba(0,0,0,.15)}
  .oddbox input{width:90px;max-width:100%;border:0;outline:0;font-size:22px;font-weight:900;text-align:center;background:transparent}
  .oddbox input::placeholder{color:#94a3b8;opacity:.7}
  h2{margin:0 0 10px;font-size:18px;font-weight:900}
  .tier{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
  .tier h3{margin:0 0 8px;font-size:15px;letter-spacing:.3px}
  .list{list-style:none;margin:0;padding:0}
  .chip{display:inline-flex;align-items:center;gap:6px;background:#0e1b2e;border:1px solid var(--border);border-radius:999px;padding:6px 10px;margin:5px 6px 5px 0}
  .dot{width:14px;height:14px;border-radius:4px;border:1px solid rgba(255,255,255,.35)}
  .note{color:var(--muted);font-size:12px}
  .btn{background:#10b981;color:#052;border:0;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer}
  .btn.ghost{background:transparent;color:#9fd;border:1px solid #1f9}
  .stack{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  textarea{width:100%;height:180px;background:#0a1526;color:#cbd5e1;border:1px solid var(--border);border-radius:12px;padding:10px}
  table{width:100%;border-collapse:collapse;font-size:14px} th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
  thead th{position:sticky;top:0;background:#0f1e36}
  @media (max-width:1000px){ .board{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" title="Erenin İtleri">
        <svg viewBox="0 0 64 64" fill="none" aria-hidden="true">
          <path d="M6 42c6-8 14-12 24-12 11 0 17-5 23-10 5-4 10-6 15-5 6 1 9 7 13 12 5 6 14 6 20 8 2 1 4 2 5 4 1 3 0 5-3 5-7 1-14-1-21-2-4-1-9-2-13-2-4 0-7 3-9 6-2 4-4 7-8 9-4 2-9 1-13 0-7-2-14-5-21-7-4-1-10-1-14-5-1-2-1-3 1-5Z" fill="#fff" opacity=".95" transform="translate(-6 -18) scale(.5)"/>
        </svg>
      </div>
      <div>
        <h1>ERENİN İTLERİ</h1>
        <div class="sub">Oran girişi • arşiv • tekrarsız CFC • güven yüzdesi</div>
      </div>
    </div>
    <div class="clock" id="clock">--:--</div>
  </header>

  <section class="board">
    <!-- SOL PANEL -->
    <div class="panel">
      <div class="mini">
        <div><div class="pill">RaceID</div><div id="raceId" class="sub">—</div></div>
        <div style="text-align:right"><div class="pill">Start</div><div id="startTime" class="sub">—</div></div>
      </div>

      <!-- PANO 1-4 / 2-5 / 3-6 -->
      <div class="grid racegrid" style="margin-top:12px">
        <div class="grid">
          <div class="row">
            <div class="dogcard"><div class="badge b1">1</div><div class="oddbox"><input id="o1" inputmode="decimal" placeholder="8,00"/></div></div>
            <div class="dogcard"><div class="badge b4">4</div><div class="oddbox"><input id="o4" inputmode="decimal" placeholder="8,00"/></div></div>
          </div>
          <div class="row">
            <div class="dogcard"><div class="badge b2">2</div><div class="oddbox"><input id="o2" inputmode="decimal" placeholder="3,70"/></div></div>
            <div class="dogcard"><div class="badge b5">5</div><div class="oddbox"><input id="o5" inputmode="decimal" placeholder="3,70"/></div></div>
          </div>
          <div class="row">
            <div class="dogcard"><div class="badge b3">3</div><div class="oddbox"><input id="o3" inputmode="decimal" placeholder="6,30"/></div></div>
            <div class="dogcard"><div class="badge b6">6</div><div class="oddbox"><input id="o6" inputmode="decimal" placeholder="5,10"/></div></div>
          </div>
        </div>

        <!-- AKSİYON + KUPON + UYARI -->
        <div class="grid">
          <div class="tier">
            <h3>İşlemler</h3>
            <div class="stack" style="margin:6px 0 10px">
              <button class="btn" id="makeBtn">Tahmin Üret</button>
              <button class="btn ghost" id="resetBtn">Oranları Sıfırla</button>
            </div>
            <div class="note" id="status">Oranları gir, sonra “Tahmin Üret”.</div>
          </div>

          <div class="tier">
            <h3>Kupon Çıktısı</h3>
            <textarea id="coupon"></textarea>
            <div class="stack" style="margin-top:8px">
              <button class="btn" id="copyBtn">Kopyala</button>
              <button class="btn ghost" id="waBtn">WhatsApp</button>
              <button class="btn ghost" id="dlBtn">.txt indir</button>
            </div>
          </div>

          <div class="tier" id="warn" style="display:none">
            <h3>⚠️ Bu el için uyarı</h3>
            <div class="note" id="warnText">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SAĞ PANEL: TAHMİNLER -->
    <div class="panel">
      <h2>3’lü CFC</h2>
      <div class="grid" style="margin-bottom:12px">
        <div class="tier"><h3>BANKO</h3><ul class="list" id="b3"></ul></div>
        <div class="tier"><h3>BANKOYA YAKIN</h3><ul class="list" id="n3"></ul></div>
        <div class="tier"><h3>SÜRPRİZ</h3><ul class="list" id="s3"></ul></div>
      </div>
      <h2>4’lü CFC</h2>
      <div class="grid">
        <div class="tier"><h3>BANKO</h3><ul class="list" id="b4"></ul></div>
        <div class="tier"><h3>BANKOYA YAKIN</h3><ul class="list" id="n4"></ul></div>
        <div class="tier"><h3>SÜRPRİZ</h3><ul class="list" id="s4"></ul></div>
      </div>
      <p class="note" style="margin-top:10px">Not: Geçmiş yoksa sıralama düşük orandan yükseğe göre. Permütasyonlar tek satıra indirilir.</p>
    </div>
  </section>

  <!-- ALT: EXCEL YÜKLE + SONUÇ EKLE / ARŞİV -->
  <section class="grid" style="margin-top:16px">
    <div class="panel">
      <h2>Excel’i Yükle (Geçmiş Veriler) — İstersen</h2>
      <div class="stack">
        <input id="excel" type="file" accept=".xlsx,.xls"/>
        <button id="clearExcel" class="btn ghost">Excel Verisini Temizle</button>
      </div>
      <p class="note" id="excelStatus" style="margin-top:6px">Başlıklar esnek: YARIŞ NO, 1–6 ORAN, KAZANAN1/2, GELEN ORAN.</p>
      <div id="histPreview" class="note" style="margin-top:8px"></div>
    </div>

    <div class="panel">
      <h2>Yarış Sonucu Ekle (Yerel Arşiv)</h2>
      <div class="grid" style="grid-template-columns:repeat(3,1fr)">
        <div><label class="note">Yarış No</label><input type="text" id="resRaceNo" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0a1526;color:#cbd5e1" placeholder="örn. 12"/></div>
        <div><label class="note">1. Gelen (1..6)</label><input type="text" id="resW1" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0a1526;color:#cbd5e1" placeholder="örn. 4"/></div>
        <div><label class="note">2. Gelen (1..6)</label><input type="text" id="resW2" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0a1526;color:#cbd5e1" placeholder="örn. 5"/></div>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr;margin-top:10px">
        <div><label class="note">Gelen Oran (Toplam)</label><input type="text" id="resPayout" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0a1526;color:#cbd5e1" placeholder="örn. 38,50"/></div>
        <div class="stack" style="align-items:flex-end"><button class="btn" id="resSaveBtn">Kaydet</button><button class="btn ghost" id="resExportBtn">Arşivi İndir (.json)</button><input type="file" id="resImportFile" accept=".json"/><button class="btn ghost" id="resClearBtn">Arşivi Temizle</button></div>
      </div>
      <p class="note" id="resStatus" style="margin-top:6px"></p>
    </div>

    <div class="panel" style="grid-column:1/-1">
      <h2>Birleşik Arşiv (Excel + Yerel)</h2>
      <div id="archiveBox" class="note">Henüz kayıt yok.</div>
    </div>
  </section>
</div>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ===== KÜÇÜK YARDIMCILAR ===== */
const $ = (id)=>document.getElementById(id);
const trapColor=(n)=>({1:'var(--r1)',2:'var(--r2)',3:'var(--r3)',4:'var(--r4)',5:'var(--r5)',6:'var(--r6)'}[n]||'#999');
const parseNumberLike=(v)=>{ if(v==null) return null; const s=String(v).replace(/,/g,'.').replace(/\s+/g,'').trim(); const n=Number(s); return isNaN(n)?null:n; };
const norm=(arr)=>arr.map(x=>x==null?NaN:Number(x.toFixed(2)));
const sorted=(a)=>[...a].sort((x,y)=>x-y);
const eq=(a,b)=>a.length===b.length && a.every((v,i)=>v===b[i]);
const labelOdds=(od)=>od.map(o=>isNaN(o)?'-':o.toFixed(2)).join(' / ');
const comboText=(c,od)=> `${c.join('x')} (${c.map(r=> (od[r-1]??NaN).toFixed(2)).join(' / ')})`;
const unique=(arr)=>{const S=new Set, out=[]; for(const c of arr){const k=c.join('-'); if(!S.has(k)){S.add(k); out.push(c);}} return out;};
const canonicalKey=(c)=>[...c].sort((a,b)=>a-b).join('-');
const collapseBySet=(list,od,scoreFn)=>{ const best=new Map(); for(const c of list){ const key=canonicalKey(c); const s=scoreFn(c,od); const p=best.get(key); if(!p||s>p.s) best.set(key,{c,s}); } return [...best.values()].map(x=>x.c); };
const LS_LOCAL = "tazi_local_results_v1";

/* ===== SAAT ===== */
setInterval(()=>{ const d=new Date(); const p=n=>String(n).padStart(2,'0'); $('clock').textContent=`${p(d.getHours())}:${p(d.getMinutes())}`; },1000);

/* ===== ORAN GİRİŞİ ===== */
const readOdds=()=>{ const vals=[1,2,3,4,5,6].map(i=>parseNumberLike($('o'+i).value)); if(vals.some(v=>v==null)) return null; return norm(vals); };
const saveOdds=()=>{ const vals=[1,2,3,4,5,6].map(i=>$('o'+i).value); localStorage.setItem('eren_odds', JSON.stringify(vals)); };
const loadOdds=()=>{ try{ const raw=localStorage.getItem('eren_odds'); if(!raw) return; const vals=JSON.parse(raw); if(Array.isArray(vals)&&vals.length===6){ [1,2,3,4,5,6].forEach(i=>$('o'+i).value=vals[i-1]??''); } }catch{} };
loadOdds(); [1,2,3,4,5,6].forEach(i=> $('o'+i).addEventListener('input',saveOdds));
$('resetBtn').onclick=()=>{ [1,2,3,4,5,6].forEach(i=>$('o'+i).value=''); localStorage.removeItem('eren_odds'); $('status').textContent='Oranlar sıfırlandı.'; setTimeout(()=>$('status').textContent='',2000); };

/* ===== EXCEL YÜKLE (OPSİYONEL) ===== */
let excelHistory = [];
const readHistoryFromSheet=(sheet)=>{
  const rows = XLSX.utils.sheet_to_json(sheet,{header:1,raw:false});
  if(!rows.length) return [];
  const header=rows[0].map(h=>h==null?'':String(h));
  const lower=header.map(c=>String(c||'').toLowerCase().trim());
  const find=(names)=>{ for(const t of names){ const i=lower.indexOf(t.toLowerCase()); if(i!==-1) return i; } return -1; };
  const alias = {
    raceNo:["YARIŞ NO","Yaris No","Race","RACE","RACE NO","RACE_ID","RACE NO."],
    o1:["1.TAZININ ORANI","1 TAZI","1","O1","1. ORAN","Runner 1"],
    o2:["2.TAZININ ORANI","2 TAZI","2","O2","2. ORAN","Runner 2"],
    o3:["3.TAZININ ORANI","3 TAZI","3","O3","3. ORAN","Runner 3"],
    o4:["4.TAZININ ORANI","4 TAZI","4","O4","4. ORAN","Runner 4"],
    o5:["5.TAZININ ORANI","5 TAZI","5","O5","5. ORAN","Runner 5"],
    o6:["6.TAZININ ORANI","6 TAZI","6","O6","6. ORAN","Runner 6"],
    w1:["KAZANAN 1","1.GELEN","Winner 1","W1"],
    w2:["KAZANAN 2","2.GELEN","Winner 2","W2"],
    pay:["GELEN ORAN","Sonuç Oran","Result","Payout","Return"],
  };
  let idx={raceNo:find(alias.raceNo), o1:find(alias.o1), o2:find(alias.o2), o3:find(alias.o3), o4:find(alias.o4), o5:find(alias.o5), o6:find(alias.o6), w1:find(alias.w1), w2:find(alias.w2), pay:find(alias.pay)};
  const fallback = Object.values(idx).every(v=>v===-1) && header.length>=10;
  if(fallback){ idx={raceNo:0,o1:1,o2:2,o3:3,o4:4,o5:5,o6:6,w1:7,w2:8,pay:9}; }
  const out=[];
  for(let r=1;r<rows.length;r++){
    const row=rows[r]||[];
    const odds=[idx.o1,idx.o2,idx.o3,idx.o4,idx.o5,idx.o6].map(i=> i===-1?null:parseNumberLike(row[i]));
    if(odds.filter(x=>x!=null).length<6) continue;
    out.push({
      raceNo: idx.raceNo===-1? r : row[idx.raceNo],
      odds: norm(odds),
      winner1: idx.w1===-1? null : parseNumberLike(row[idx.w1]),
      winner2: idx.w2===-1? null : parseNumberLike(row[idx.w2]),
      resultPayout: idx.pay===-1? null : parseNumberLike(row[idx.pay]),
      __raw:{source:'excel'}
    });
  }
  return out;
};
$('excel').onchange=(e)=>{
  const file=e.target.files && e.target.files[0]; if(!file) return;
  $('excelStatus').textContent='Yükleniyor…';
  const reader=new FileReader();
  reader.onload=(ev)=>{
    try{
      const wb=XLSX.read(new Uint8Array(ev.target.result),{type:'array'});
      const sheet=wb.Sheets[wb.SheetNames[0]];
      excelHistory = readHistoryFromSheet(sheet);
      $('excelStatus').textContent=`Excel yüklendi: ${excelHistory.length} satır okundu.`;
      paintArchive();
      paintHistPreview();
    }catch(err){ $('excelStatus').textContent='Excel okunamadı: '+(err?.message||String(err)); }
  };
  reader.readAsArrayBuffer(file);
};
$('clearExcel').onclick=()=>{ excelHistory=[]; $('excel').value=''; $('excelStatus').textContent='Excel verisi temizlendi.'; paintArchive(); paintHistPreview(); };
const paintHistPreview=()=>{
  const box=$('histPreview');
  if(!excelHistory.length){ box.innerHTML=''; return; }
  box.innerHTML = `<div style="max-height:180px;overflow:auto;border:1px solid var(--border);border-radius:10px;background:#0a1526">
  <table><thead><tr><th>Yarış</th><th>Oranlar</th><th>1.Gelen</th><th>2.Gelen</th><th>Gelen Oran</th></tr></thead>
  <tbody>${excelHistory.slice(0,20).map(r=>`<tr><td>${String(r.raceNo??'-')}</td><td>${labelOdds(r.odds)}</td><td>${r.winner1??'-'}</td><td>${r.winner2??'-'}</td><td>${r.resultPayout!=null?(r.resultPayout.toFixed?r.resultPayout.toFixed(2):r.resultPayout):'-'}</td></tr>`).join('')}</tbody></table></div>
  <div class="note" style="margin-top:6px">Örnek ilk 20 satır gösterildi.</div>`;
};

/* ===== YEREL ARŞİV ===== */
let localResults = []; // kalıcı (tarayıcıda)
const loadLocal=()=>{ try{ const raw=localStorage.getItem(LS_LOCAL); if(raw){ const arr=JSON.parse(raw); if(Array.isArray(arr)) localResults=arr; } }catch{} };
const saveLocal=()=>{ localStorage.setItem(LS_LOCAL, JSON.stringify(localResults)); };
loadLocal();

const historyRowKey=(hr)=>{ const odds=(hr?.odds||[]).map(x=>isNaN(x)?'NaN':x.toFixed(2)).join('|');
  const w1=hr?.winner1??'-', w2=hr?.winner2??'-';
  const po=(hr?.resultPayout==null)?'-':Number(hr.resultPayout).toFixed(2);
  return `${odds}__${w1}_${w2}_${po}`; };

const mergeHistories=(a,b)=>{ const m=new Map(); for(const r of [...(a||[]),...(b||[])]){ if(!r||!Array.isArray(r.odds)||r.odds.length!==6) continue; const k=historyRowKey(r); if(!m.has(k)) m.set(k,r); } return [...m.values()]; };

const renderArchiveBox=(rows)=>{
  const box=$('archiveBox');
  if(!rows.length){ box.innerHTML='Henüz kayıt yok.'; return; }
  box.innerHTML=`<div style="max-height:260px;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#0a1526">
  <table><thead><tr><th>Yarış</th><th>Oranlar</th><th>1.Gelen</th><th>2.Gelen</th><th>Gelen Oran</th><th>Kaynak</th></tr></thead>
  <tbody>${rows.map(r=>`<tr><td>${String(r.raceNo??'-')}</td><td>${labelOdds(r.odds)}</td><td>${r.winner1??'-'}</td><td>${r.winner2??'-'}</td><td>${r.resultPayout!=null?(r.resultPayout.toFixed?r.resultPayout.toFixed(2):r.resultPayout):'-'}</td><td>${r.__raw?.source||'excel'}</td></tr>`).join('')}</tbody></table></div>`;
};
const paintArchive=()=> renderArchiveBox( mergeHistories(excelHistory, localResults) );
paintArchive();

$('resSaveBtn').onclick=()=>{
  const odds=[1,2,3,4,5,6].map(()=>null);
  const cur=readOdds(); if(cur) cur.forEach((v,i)=>odds[i]=v); // soldaki oranlardan kopyala
  if(odds.some(v=>v==null)){ $('resStatus').textContent='6 oranın da dolu olması gerekir.'; return; }
  const row = {
    raceNo: $('resRaceNo').value?.trim()||undefined,
    odds: norm(odds),
    winner1: parseNumberLike($('resW1').value),
    winner2: parseNumberLike($('resW2').value),
    resultPayout: parseNumberLike($('resPayout').value),
    __raw:{source:'local'}
  };
  const key=historyRowKey(row);
  const exists = mergeHistories(excelHistory, localResults).some(r=>historyRowKey(r)===key);
  if(exists){ $('resStatus').textContent='Bu kayıt zaten var (atlandı).'; return; }
  localResults=[...localResults, row]; saveLocal(); $('resStatus').textContent='Kayıt eklendi.'; setTimeout(()=>$('resStatus').textContent='',1500); paintArchive();
};
$('resExportBtn').onclick=()=>{ const blob=new Blob([JSON.stringify(localResults||[],null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tazi-arsiv.json'; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); };
$('resImportFile').onchange=(e)=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{ try{ const arr=JSON.parse(ev.target.result); if(!Array.isArray(arr)) throw new Error('Geçersiz JSON'); const cleaned=arr.map(x=>({raceNo:x.raceNo,odds:norm((x.odds||[]).map(parseNumberLike)),winner1:parseNumberLike(x.winner1),winner2:parseNumberLike(x.winner2),resultPayout:parseNumberLike(x.resultPayout),__raw:{source:'localImport'}})).filter(r=>Array.isArray(r.odds)&&r.odds.length===6); localResults=mergeHistories([], [...localResults, ...cleaned]); saveLocal(); $('resStatus').textContent='Arşiv içe aktarıldı.'; setTimeout(()=>{$('resStatus').textContent='';},1500); paintArchive(); }catch(err){ $('resStatus').textContent='JSON okunamadı: '+(err?.message||String(err)); } }; r.readAsText(f,'utf-8'); };
$('resClearBtn').onclick=()=>{ if(!confirm('Yerel arşivi silinsin mi?')) return; localStorage.removeItem(LS_LOCAL); localResults=[]; $('resStatus').textContent='Yerel arşiv temizlendi.'; setTimeout(()=>{$('resStatus').textContent='';},1500); paintArchive(); };

/* ===== TAHMİN MOTORU ===== */
const makeConfidence=(runnerScores,k)=>{ const w3=[.5,.3,.2], w4=[.4,.3,.2,.1], W=(k===4?w4:w3), alpha=.6; return (combo,od)=>{ const ps=combo.map(r=>{const o=od[r-1];return o&&o>0?1/o:0}); const sum=ps.reduce((a,b)=>a+b,0)||1e-9; const pN=ps.map(p=>p/sum); const rs=combo.map(r=>runnerScores[r-1]||0); const max=Math.max(1,...runnerScores); const rN=rs.map(s=>s/max); let score=100*(alpha*pN.reduce((a,p,i)=>a+W[i]*p,0)+(1-alpha)*rN.reduce((a,s,i)=>a+W[i]*s,0)); return Math.max(5,Math.min(95,score)); };};
const byRank=(R,k)=>{ if(R.length<k) return {banko:[],near:[],surprise:[]}; const pick=(...xs)=>xs.slice(0,k);
  const banko=unique([pick(R[0],R[1],R[2],R[3],R[4],R[5]), pick(R[0],R[2],R[1],R[3],R[4],R[5]), pick(R[1],R[0],R[2],R[3],R[4],R[5])]);
  const near =unique([pick(R[0],R[1],R[2],R[4],R[3],R[5]), pick(R[0],R[1],R[3],R[2],R[4],R[5]), pick(R[1],R[0],R[3],R[2],R[4],R[5])]);
  const surprise=unique([pick(R[2],R[0],R[4],R[1],R[3],R[5]), pick(R[3],R[1],R[4],R[0],R[2],R[5]), pick(R[4],R[0],R[2],R[1],R[3],R[5])]);
  return {banko,near,surprise}; };
const dedupeTiers=(t)=>{ const S=new Set,k=c=>c.join('-'); return {banko:t.banko.filter(c=>{const x=k(c);if(S.has(x))return false;S.add(x);return true;}), near:t.near.filter(c=>{const x=k(c);if(S.has(x))return false;S.add(x);return true;}), surprise:t.surprise.filter(c=>{const x=k(c);if(S.has(x))return false;S.add(x);return true;})}; };

const runnerScoresFromMatches=(matches)=>{ const s=Array(6).fill(0); const count=(rows)=>{ if(!rows.length) return; const w1=Array(6).fill(0), w2=Array(6).fill(0); for(const r of rows){ if(r.winner1>=1&&r.winner1<=6) w1[r.winner1-1]++; if(r.winner2>=1&&r.winner2<=6) w2[r.winner2-1]++; } for(let i=0;i<6;i++) s[i]+= w1[i]*2 + w2[i]*1; }; count(matches.exact); count(matches.unordered); return s; };

const findMatches=(history, currentOdds)=>{
  const exact=[], unordered=[]; const sortedCur=sorted(currentOdds);
  for(const h of history){
    if(!h.odds || h.odds.length!==6) continue;
    const ex = eq(h.odds, currentOdds);
    if(ex) exact.push(h);
    const un = eq(sorted(h.odds), sortedCur);
    if(un && !ex) unordered.push(h);
  }
  return {exact, unordered};
};

const paintTier=(rootId, list, k, conf, odds)=>{
  const root=$(rootId); root.innerHTML='';
  list.slice(0,3).forEach(c=>{
    const li=document.createElement('li'); li.className='chip';
    c.forEach(n=>{ const d=document.createElement('span'); d.className='dot'; d.style.background=trapColor(n); if(n===3) d.style.border='1px solid #334155'; li.appendChild(d); });
    const txt=document.createElement('span'); txt.innerHTML = `${comboText(c,odds)} <span class="note" style="margin-left:6px">Güven: ${Math.round(conf(c,odds))}%</span>`;
    li.appendChild(txt); root.appendChild(li);
  });
  if(list.length===0) root.innerHTML='<span class="note">Yeterli kombinasyon yok.</span>';
};

$('makeBtn').onclick=()=>{
  const odds=readOdds();
  if(!odds){ $('status').textContent='Lütfen 6 oranı da gir (virgül veya nokta olur).'; return; }
  $('status').textContent='Hesaplandı.';

  const history = mergeHistories(excelHistory, localResults);
  const matches = findMatches(history, odds);
  const runnerScores = runnerScoresFromMatches(matches);

  // sıralama (geçmiş yoksa düşüğe öncelik)
  const R = runnerScores.every(v=>v===0) ? [1,2,3,4,5,6].sort((a,b)=>(odds[a-1]??999)-(odds[b-1]??999))
                                         : [1,2,3,4,5,6].sort((a,b)=>runnerScores[b-1]-runnerScores[a-1]);

  const c3raw=byRank(R,3), c4raw=byRank(R,4);
  const conf3=makeConfidence(runnerScores,3), conf4=makeConfidence(runnerScores,4);

  const t3=dedupeTiers({banko:collapseBySet(c3raw.banko,odds,conf3), near:collapseBySet(c3raw.near,odds,conf3), surprise:collapseBySet(c3raw.surprise,odds,conf3)});
  const t4=dedupeTiers({banko:collapseBySet(c4raw.banko,odds,conf4), near:collapseBySet(c4raw.near,odds,conf4), surprise:collapseBySet(c4raw.surprise,odds,conf4)});

  // uyarı
  const warns=[];
  if(t3.banko[0] && Math.round(conf3(t3.banko[0],odds))<55) warns.push('BANKO (3’lü) güveni düşük görünüyor (<%55).');
  const matchCount=(matches.exact?.length||0)+(matches.unordered?.length||0);
  if(matchCount<3) warns.push('Geçmişte bu dağılım için az kayıt var.');
  if(warns.length){ $('warnText').textContent='• '+warns.join(' • '); $('warn').style.display='block'; } else $('warn').style.display='none';

  // çiz
  paintTier('b3',t3.banko,3,conf3,odds); paintTier('n3',t3.near,3,conf3,odds); paintTier('s3',t3.surprise,3,conf3,odds);
  paintTier('b4',t4.banko,4,conf4,odds); paintTier('n4',t4.near,4,conf4,odds); paintTier('s4',t4.surprise,4,conf4,odds);

  // kupon
  const lines=[];
  const add=(title,arr,k,conf)=>{ lines.push(title); arr.slice(0,3).forEach((c,i)=> lines.push(`  ${i+1}. ${comboText(c,odds)} (Güven: ${Math.round(conf(c,odds))}%)`)); lines.push(''); };
  lines.push("3'lü CFC"); add('BANKO',t3.banko,3,conf3); add('BANKOYA YAKIN',t3.near,3,conf3); add('SÜRPRİZ',t3.surprise,3,conf3);
  lines.push("4'lü CFC"); add('BANKO',t4.banko,4,conf4); add('BANKOYA YAKIN',t4.near,4,conf4); add('SÜRPRİZ',t4.surprise,4,conf4);
  $('coupon').value=lines.join('\n');
};

/* Kupon aksiyonları */
$('copyBtn').onclick=async()=>{ try{ await navigator.clipboard.writeText($('coupon').value||''); $('status').textContent='Kupon kopyalandı.'; setTimeout(()=>$('status').textContent='',1500);}catch{ $('status').textContent='Elle kopyalayabilirsin.'; setTimeout(()=>$('status').textContent='',2000);} };
$('waBtn').onclick=()=> window.open('https://wa.me/?text='+encodeURIComponent($('coupon').value||''), '_blank');
$('dlBtn').onclick=()=>{ const blob=new Blob([$('coupon').value||''],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='erenin-itleri-kupon.txt'; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); };
</script>
</body>
</html>
